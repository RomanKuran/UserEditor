$(document).ready(function () {
    getUsers();

    // event get user by id (edit)
    $(document).on('click', '.js-check-edit-user', function () {
        let user_id = $(this).attr('data-id');
        getUserById(user_id);
    })
    // ----

    // event edit user
    $(document).on('click', '.js-edit-user', function () {
        let user_id = $(this).attr('data-id');

        let first_name = $('.js-form-edit-user input[name=first_name]').val();
        let last_name = $('.js-form-edit-user input[name=last_name]').val();
        let email = $('.js-form-edit-user input[name=email]').val();
        let password = $('.js-form-edit-user input[name=password]').val();

        editUser(user_id, first_name, last_name, email, password);
    })
    // ----

    // event create user
    $(document).on('click', '.js-create-user', function () {
        let first_name = $('.js-form-create-user input[name=first_name]').val();
        let last_name = $('.js-form-create-user input[name=last_name]').val();
        let email = $('.js-form-create-user input[name=email]').val();
        let password = $('.js-form-create-user input[name=password]').val();

        createUser(first_name, last_name, email, password);
    })
    // ----
});

// function get users
function getUsers() {
    if (localStorage.token != undefined) {
        $.ajax({
            type: "GET",
            url: route_get_users,
            dataType: 'json',
            data: {
                token: localStorage.token
            },
            success: function (result) {
                formingTableUsers(result.users)
            }
        });
    }
}
// ----

// function of forming the table of users
function formingTableUsers(users) {
    $('.js-table-users tbody .js-user-item').remove();
    let object_user_item = dom_user_item;
    users.forEach(element => {
        object_user_item = dom_user_item;
        object_user_item = $(object_user_item).attr('data-id', element.id);
        object_user_item.find('.js-field-first-name').text(element.first_name);
        object_user_item.find('.js-field-last-name').text(element.last_name);
        object_user_item.find('.js-field-email').text(element.email);
        object_user_item.find('.js-check-edit-user').attr('data-id', element.id);
        $('.js-table-users tbody').append(object_user_item);
    });

    if (localStorage.user_status == 'user') {
        $('.js-table-users .btn-warning').remove();
    }
}
// ----


// function get user by id
function getUserById(user_id) {
    $.ajax({
        type: "GET",
        url: route_get_user_by_id,
        dataType: 'json',
        data: {
            token: localStorage.token,
            userId: user_id
        },
        success: function (result) {
            let user = result.user;
            $('.js-form-edit-user input[name=first_name]').val(user.first_name);
            $('.js-form-edit-user input[name=last_name]').val(user.last_name);
            $('.js-form-edit-user input[name=email]').val(user.email);
            $('#modalEditUser .js-edit-user').attr('data-id', user.id);
        }
    });
}
// ----

// function edit user
function editUser(user_id, first_name, last_name, email, password) {
    $.ajax({
        type: "POST",
        url: route_edit_user,
        dataType: 'json',
        data: {
            token: localStorage.token,
            userId: user_id,
            firstName: first_name,
            lastName: last_name,
            email: email,
            password: password,
        },
        success: function (result) {
            getUsers();
            $('#modalEditUser').modal('toggle');
        }
    });
}
// ----

// function create user
function createUser(first_name, last_name, email, password) {
    $.ajax({
        type: "POST",
        url: route_create_user,
        dataType: 'json',
        data: {
            token: localStorage.token,
            firstName: first_name,
            lastName: last_name,
            email: email,
            password: password,
        },
        success: function (result) {
            getUsers();
            $('#modalCreateUser').modal('toggle');
        }
    });
}
// ----

$(document).ready(function () {
    if(localStorage.token != undefined){
        checkStatusUser();
    }

    // event registration user
    $(document).on('click', '.js-register', function () {
        let registration_data = {};
        let field_name = null;
        let value = null;

        $('.js-form-register-user.js-form-fields input').each(function (index) {
            field_name = $(this).attr('name');
            value = $(this).val();
            registration_data[field_name] = value;
        });

        registrationUser(registration_data);
    })
    // ----

    // event login user
    $(document).on('click', '.js-login', function () {
        let login_data = {};
        let field_name = null;
        let value = null;

        $('.js-form-login-user.js-form-fields input').each(function (index) {
            field_name = $(this).attr('name');
            value = $(this).val();
            login_data[field_name] = value;
        });

        loginUser(login_data);
    })
    // ----

    // event logout
    $(document).on('click', '.js-logout', function () {
        logoutUser();
    })
    // ----
})

// function registration user
function registrationUser(registration_data) {
    $.ajax({
        type: "POST",
        url: route_registration,
        dataType: 'json',
        data: registration_data,
        success: function (result) {
            $('#modalRegister').modal('toggle');
            alert('Please log in!');
        }
    });
}
// ----

// function login user
function loginUser(registration_data) {
    $.ajax({
        type: "POST",
        url: route_login,
        dataType: 'json',
        data: registration_data,
        success: function (result) {
            localStorage.token = result.token;
            localStorage.user_status = result.user_status;
            getUsers();
            checkStatusUser();
            // $('.js-buttons-auth-guest').addClass('d-none');
            // $('.js-buttons-auth-login-user').removeClass('d-none');
            $('#modalLogin').modal('toggle');
        }
    });
}
// ----

// function check statys user
function checkStatusUser() {
    $.ajax({
        type: "GET",
        url: route_get_user,
        dataType: 'json',
        data: {
            token: localStorage.token
        },
        success: function (result) {
            // console.log(localStorage.token != undefined, (result.status == "Authorization Token not found" || result.status == "Token is Expired"));
            if (result.status == "Authorization Token not found" || result.status == "Token is Expired") {
                localStorage.clear();
                document.location.reload();
            } else {
                $('.js-buttons-auth-guest').addClass('d-none');
                $('.js-buttons-auth-login-user').removeClass('d-none');
                if(localStorage.user_status == 'admin'){
                    $('.js-container-create-user').removeClass('d-none');
                }
            }
        }
    });
}
// ----

// function logout user
function logoutUser() {
    $.ajax({
        type: "GET",
        url: route_logout,
        dataType: 'json',
        data: {
            token: localStorage.token
        },
        success: function (result) {
            localStorage.clear();
            document.location.reload();
            checkStatusUser()
        }
    });
}
// ----
